"""
å°çº¢ä¹¦ç¬”è®°ç”Ÿæˆå™¨
"""
import re
from typing import Optional, List, Tuple
import logging

from ..ai_processor import AIProcessor


class XiaohongshuGenerator:
    """å°çº¢ä¹¦ç¬”è®°ç”Ÿæˆå™¨"""

    def __init__(
        self,
        ai_processor: AIProcessor,
        logger: Optional[logging.Logger] = None
    ):
        """
        åˆå§‹åŒ–ç”Ÿæˆå™¨

        Args:
            ai_processor: AI å¤„ç†å™¨
            logger: æ—¥å¿—è®°å½•å™¨
        """
        self.ai_processor = ai_processor
        self.logger = logger or logging.getLogger(__name__)

    def generate(
        self,
        content: str,
        max_tokens: int = 2000
    ) -> Tuple[str, List[str], List[str]]:
        """
        ç”Ÿæˆå°çº¢ä¹¦ç¬”è®°ï¼ˆåˆ†ä¸¤æ­¥ï¼šå…ˆç”Ÿæˆæ ‡é¢˜ï¼Œå†ç”Ÿæˆæ­£æ–‡ï¼‰

        Args:
            content: è¾“å…¥å†…å®¹
            max_tokens: æœ€å¤§ token æ•°

        Returns:
            (ç¬”è®°å†…å®¹, æ ‡é¢˜åˆ—è¡¨, æ ‡ç­¾åˆ—è¡¨) å…ƒç»„
        """
        # ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆ5ä¸ªæ ‡é¢˜
        self.logger.info("ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå°çº¢ä¹¦æ ‡é¢˜...")
        titles = self._generate_titles(content)

        if not titles:
            self.logger.warning("æ ‡é¢˜ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æµç¨‹")
            titles = ["å°çº¢ä¹¦ç¬”è®°"]

        # é€‰æ‹©ç¬¬ä¸€ä¸ªæ ‡é¢˜ä½œä¸ºä¸»æ ‡é¢˜
        main_title = titles[0] if titles else "å°çº¢ä¹¦ç¬”è®°"
        self.logger.info(f"å·²ç”Ÿæˆ {len(titles)} ä¸ªæ ‡é¢˜ï¼Œä¸»æ ‡é¢˜: {main_title[:30]}...")

        # ç¬¬äºŒæ­¥ï¼šç”Ÿæˆæ­£æ–‡å†…å®¹
        self.logger.info("ç¬¬äºŒæ­¥ï¼šç”Ÿæˆå°çº¢ä¹¦æ­£æ–‡...")
        xiaohongshu_content = self._generate_content(content, main_title, max_tokens)

        if not xiaohongshu_content:
            return content, titles, []

        # æå–æ ‡ç­¾
        tags = self._extract_tags(xiaohongshu_content)

        return xiaohongshu_content, titles, tags

    def _generate_titles(self, content: str) -> List[str]:
        """
        ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆ5ä¸ªä¸åŒé£æ ¼çš„æ ‡é¢˜

        Args:
            content: è¾“å…¥å†…å®¹

        Returns:
            æ ‡é¢˜åˆ—è¡¨
        """
        system_prompt = self._build_title_system_prompt()
        user_prompt = self._build_title_user_prompt(content)

        result = self.ai_processor.generate_completion(
            system_prompt=system_prompt,
            user_prompt=user_prompt,
            temperature=0.8,  # ç¨é«˜æ¸©åº¦å¢åŠ åˆ›æ„
            max_tokens=500  # æ ‡é¢˜ä¸éœ€è¦å¤ªå¤štoken
        )

        if not result:
            return []

        # è§£ææ ‡é¢˜
        titles = []
        for line in result.split('\n'):
            line = line.strip()
            # ç§»é™¤åºå·å’Œæ ‡è®°
            line = re.sub(r'^\d+[.ã€)\]]\s*', '', line)
            line = re.sub(r'^\[?æ ‡é¢˜\d*\]?\s*', '', line, flags=re.IGNORECASE)
            line = re.sub(r'^[-*]\s*', '', line)

            if line and len(line) > 5 and len(line) < 50:
                titles.append(line)

        return titles[:5]  # æœ€å¤šè¿”å›5ä¸ª

    def _generate_content(self, content: str, title: str, max_tokens: int) -> str:
        """
        ç¬¬äºŒæ­¥ï¼šæ ¹æ®é€‰å®šçš„æ ‡é¢˜ç”Ÿæˆæ­£æ–‡

        Args:
            content: è¾“å…¥å†…å®¹
            title: é€‰å®šçš„æ ‡é¢˜
            max_tokens: æœ€å¤§tokenæ•°

        Returns:
            æ­£æ–‡å†…å®¹
        """
        system_prompt = self._build_content_system_prompt()
        user_prompt = self._build_content_user_prompt(content, title)

        result = self.ai_processor.generate_completion(
            system_prompt=system_prompt,
            user_prompt=user_prompt,
            temperature=0.7,
            max_tokens=max_tokens
        )

        return result if result else ""

    def _extract_tags(self, content: str) -> List[str]:
        """
        ä»ç”Ÿæˆçš„å†…å®¹ä¸­æå–æ ‡ç­¾

        Args:
            content: ç”Ÿæˆçš„å†…å®¹

        Returns:
            æ ‡ç­¾åˆ—è¡¨
        """
        tag_matches = re.findall(r'#([^\s#]+)', content)
        return tag_matches if tag_matches else []

    def _build_title_system_prompt(self) -> str:
        """æ„å»ºæ ‡é¢˜ç”Ÿæˆçš„ç³»ç»Ÿæç¤ºè¯"""
        return """## å°çº¢ä¹¦çˆ†æ¬¾æ ‡é¢˜ç”Ÿæˆä¸“å®¶

### è§’è‰²è®¾å®š
ä½ æ˜¯ä¸€åèµ„æ·±çš„å°çº¢ä¹¦æ ‡é¢˜å¤§å¸ˆã€‚
ä½ ç²¾é€šå„ç§çˆ†æ¬¾æ ‡é¢˜åˆ›ä½œæŠ€å·§ã€‚
ä½ æ“…é•¿ç”¨æ ‡é¢˜ç¬é—´æŠ“ä½ç”¨æˆ·æ³¨æ„åŠ›ã€‚

### æ ‡é¢˜åˆ›ä½œæŠ€èƒ½

ä½ æŒæ¡ä»¥ä¸‹5ç§æ ‡é¢˜åˆ›ä½œæ–¹æ³•ï¼š
1. **æ•°å­—æ³•åˆ™**ï¼šç”¨å…·ä½“æ•°å­—å¢åŠ å¯ä¿¡åº¦ï¼ˆå¦‚"7å¤©"ã€"3ä¸ªæ–¹æ³•"ï¼‰
2. **äºŒæç®¡æ ‡é¢˜**ï¼šåˆ¶é€ å¼ºçƒˆåå·®å’Œå¯¹æ¯”æ•ˆæœ
3. **ç–‘é—®å¥å¼**ï¼šæ¿€å‘å¥½å¥‡å¿ƒï¼ˆå¦‚"ä¸ºä»€ä¹ˆ..."ã€"æ€ä¹ˆ..."ï¼‰
4. **æƒ…ç»ªå…±é¸£**ï¼šä½¿ç”¨é«˜å”¤èµ·æƒ…ç»ªè¯ï¼Œç¬é—´å”¤é†’ç”¨æˆ·å…±é¸£
5. **åˆ©ç›Šé©±åŠ¨**ï¼šç›´å‡»ç—›ç‚¹æˆ–åˆ©ç›Šç‚¹

ã€7å¤§çˆ†æ¬¾æ ‡é¢˜é£æ ¼ã€‘
- æ•°å­—æ‚¬å¿µå‹ï¼šã€3ä¸ªæ‡’äººæ”¶çº³æ³•ï¼Œæˆ¿é—´ä¸€å‘¨ä¸ä¹±ï¼ã€‘
- æƒ…æ„Ÿå…±é¸£å‹ï¼šã€è°æ‡‚å•Šï¼è¿™ç¢—é¢ç›´æ¥æ²»æ„ˆäº†æˆ‘çš„å‘¨ä¸€ï¼ã€‘
- ç»“æœå¯¼å‘å‹ï¼šã€è·Ÿç€åšä¸»åšï¼Œ7å¤©æå®šPythonåŸºç¡€ï¼ã€‘
- åå·®å¯¹æ¯”å‹ï¼šã€ä»çƒ‚è„¸åˆ°æ°´å…‰è‚Œï¼Œæˆ‘åªåšäº†è¿™ä¸¤ä»¶äº‹ã€‘
- ç¨€ç¼ºä¿¡æ¯å‹ï¼šã€è¿™10ä¸ªä¸Šæµ·å°ä¼—ç§˜å¢ƒï¼Œ90%çš„äººæ²¡å»è¿‡ã€‘
- å¯¹è¯äº’åŠ¨å‹ï¼šã€ä½ çš„æ•å¤´é€‰å¯¹äº†å—ï¼Ÿå¿«æ¥å¯¹ç…§è¿™ä»½æŒ‡å—ï¼ã€‘
- ä»·å€¼å®£è¨€å‹ï¼šã€2025å¹´æŠ•èµ„è‡ªå·±ï¼Œè¿™3é¡¹æŠ€èƒ½æœ€å€¼é’±ã€‘

### å¹³å°ç¦å¿Œè¯ï¼ˆä¸¥ç¦ä½¿ç”¨ï¼‰
ã€è¯±å¯¼ç±»ã€‘é€Ÿæ¥ã€å¿…çœ‹ã€å¿…æ”¶ã€åƒä¸‡ä¸è¦ã€é©¬ä¸Šã€æŠ“ç´§ã€æœ€åä¸€æ³¢
ã€å¤¸å¤§ç±»ã€‘å…¨ç½‘ç¬¬ä¸€ã€æœ€å…¨ã€æœ€å¼ºã€å²ä¸Šã€ç»ˆæã€å®Œç¾ã€å¤©èŠ±æ¿ã€å°ç¥
ã€è¥é”€ç±»ã€‘å…è´¹é€ã€0å…ƒè´­ã€è–…ç¾Šæ¯›ã€ç¦åˆ©ã€çº¢åŒ…ã€ç‚¹å‡»é¢†å–ã€ä»·æ ¼æ„Ÿäºº
ã€è´Ÿé¢ç±»ã€‘ä¸‘å“­ã€è¸©é›·ã€è¡€äºã€åˆ«ä¹°ã€é¿å‘ã€åƒåœ¾ã€åæ‚”ã€ç¿»è½¦

### æ ‡é¢˜åˆ›ä½œè¦æ±‚
1. æ¯ä¸ªæ ‡é¢˜ä½¿ç”¨ä¸åŒçš„çˆ†æ¬¾æ ‡é¢˜é£æ ¼
2. ä¸¥ç¦ä½¿ç”¨å¹³å°ç¦å¿Œè¯
3. emojiä¼˜å…ˆç”¨âœ¨ğŸ”¥âœ…ğŸ’¡â—ï¸ğŸ˜­ğŸ¤”ğŸ’ªï¼Œæ¯ä¸ªæ ‡é¢˜æœ€å¤š2ä¸ª
4. é¿å…"XXåˆ†äº«""XXç¬”è®°"ç­‰æ— æ•ˆè¯
5. ä½¿ç”¨"äº²æµ‹""è¯•è¿‡""æˆ‘å‘ç°"ç­‰çœŸå®æ„Ÿè¡¨è¿°
6. æ¯ä¸ªæ ‡é¢˜å­—æ•°æ§åˆ¶åœ¨20å­—ä»¥å†…
7. æ ‡é¢˜è¦æœ‰å¸å¼•åŠ›ï¼Œè®©äººå¿ä¸ä½ç‚¹è¿›æ¥çœ‹"""

    def _build_title_user_prompt(self, content: str) -> str:
        """æ„å»ºæ ‡é¢˜ç”Ÿæˆçš„ç”¨æˆ·æç¤ºè¯"""
        return f"""è¯·æ ¹æ®ä»¥ä¸‹å†…å®¹ï¼Œç”Ÿæˆ5ä¸ªä¸åŒé£æ ¼çš„å°çº¢ä¹¦çˆ†æ¬¾æ ‡é¢˜ã€‚

å†…å®¹æ¦‚è¦ï¼š
{content[:500]}...

è¦æ±‚ï¼š
1. ç”Ÿæˆ5ä¸ªæ ‡é¢˜ï¼Œæ¯ä¸ªä½¿ç”¨ä¸åŒçš„çˆ†æ¬¾æ ‡é¢˜é£æ ¼
2. ç›´æ¥è¾“å‡º5ä¸ªæ ‡é¢˜ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œä¸è¦æ·»åŠ åºå·å’Œè¯´æ˜
3. ä¸¥æ ¼éµå®ˆå¹³å°ç¦å¿Œè¯è§„åˆ™
4. æ¯ä¸ªæ ‡é¢˜å­—æ•°æ§åˆ¶åœ¨20å­—ä»¥å†…
5. å¿…é¡»åŒ…å«emojiï¼Œæ¯ä¸ªæ ‡é¢˜æœ€å¤š2ä¸ª

ç¤ºä¾‹æ ¼å¼ï¼š
æ•°å­—è¿·é›¾å¤§æ­ç§˜âœ¨3ä¸ªæ–¹æ³•è®©ä½ ç§’æ‡‚æ•°å­—é™·é˜±ï¼
è°æ‡‚å•ŠğŸ¤”è¿™äº›æ•°å­—é—®é¢˜æŠŠæˆ‘ç»•æ™•äº†ï¼
ä»è¢«éª—åˆ°é€è§†ğŸ’¡7å¤©å­¦ä¼šè¯†ç ´æ•°å­—å¥—è·¯
ä½ çœŸçš„æ‡‚æ•°å­—å—â—ï¸90%äººéƒ½ç­”é”™çš„é¢˜ï¼
2025å¿…å­¦æŠ€èƒ½ğŸ”¥æ•°å­—æ€ç»´è®©ä½ æ›´èªæ˜

è¯·å¼€å§‹ç”Ÿæˆï¼š"""

    def _build_content_system_prompt(self) -> str:
        """æ„å»ºæ­£æ–‡ç”Ÿæˆçš„ç³»ç»Ÿæç¤ºè¯"""
        return """## å°çº¢ä¹¦çˆ†æ¬¾æ­£æ–‡ç”Ÿæˆä¸“å®¶

### è§’è‰²è®¾å®š
ä½ æ˜¯ä¸€åèµ„æ·±çš„å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆå†™æ‰‹ã€‚
ä½ ç²¾é€šå°çº¢ä¹¦å¹³å°çš„å†…å®¹åˆ›ä½œè§„åˆ™ã€‚
ä½ æ“…é•¿åˆ›ä½œé«˜äº’åŠ¨ã€é«˜è½¬åŒ–çš„ç§è‰æ–‡æ¡ˆã€‚

### æ­£æ–‡åˆ›ä½œæŠ€èƒ½

#### 1. å†™ä½œé£æ ¼
- **è¯­è¨€é£æ ¼**ï¼šåƒæœ‹å‹èŠå¤©ï¼ŒçœŸè¯šã€ç›´æ¥ã€æœ‰æ¸©åº¦
- **å¥å¼ç»“æ„**ï¼šç®€å•æ˜äº†ï¼Œä¸»è°“å®¾æ¸…æ™°ï¼Œä¸€å¥è¯ä¸€ä¸ªæ„æ€
- **è¯æ±‡é€‰æ‹©**ï¼šå¤§ç™½è¯ä¼˜å…ˆï¼Œä¸“ä¸šæœ¯è¯­å¿…é¡»è§£é‡Š
- **æ®µè½èŠ‚å¥**ï¼šæ¯æ®µ2-3å¥ï¼Œä¿æŒå‘¼å¸æ„Ÿ

#### 2. å†™ä½œå¼€ç¯‡æ–¹æ³•
- **é‡‘å¥å¼€åœº**ï¼šç”¨ä¸€å¥è¯æŠ“ä½æ³¨æ„åŠ›
- **ç—›ç‚¹åˆ‡å…¥**ï¼šç›´æ¥è¯´å‡ºç”¨æˆ·å›°æ‰°
- **åè½¬å¼€åœº**ï¼šå…ˆè¯´å¸¸è§è¯¯åŒºï¼Œå†ç»™å‡ºæ­£ç¡®æ–¹æ³•
- **æ•…äº‹å¼•å…¥**ï¼šç”¨ä¸ªäººç»å†å¼•å‘å…±é¸£

#### 3. æ–‡æœ¬ç»“æ„
- **å¼€å¤´**ï¼šemoji+é‡‘å¥/ç—›ç‚¹ï¼ˆ1-2å¥è¯ï¼‰
- **ä¸»ä½“**ï¼šåˆ†ç‚¹å™è¿°ï¼Œæ¯ç‚¹å‰åŠ emojiï¼Œ3-5ä¸ªè¦ç‚¹
- **æ¯ä¸ªè¦ç‚¹åŒ…å«**ï¼šå…·ä½“æ–¹æ³•+ä¸ªäººä½“éªŒ+æ•ˆæœè¯´æ˜
- **ç»“å°¾**ï¼šæ€»ç»“+äº’åŠ¨å¼•å¯¼

#### 4. äº’åŠ¨å¼•å¯¼æ–¹æ³•
- **æé—®å¼**ï¼š"ä½ ä»¬æœ‰é‡åˆ°è¿™ç§æƒ…å†µå—ï¼Ÿ"
- **å¾é›†å¼**ï¼š"è¯„è®ºåŒºè¯´è¯´ä½ çš„æ–¹æ³•ï½"
- **è¡ŒåŠ¨å¼**ï¼š"èµ¶ç´§æ”¶è—èµ·æ¥ï¼"
- **å…±é¸£å¼**ï¼š"å§å¦¹ä»¬æ‡‚æˆ‘çš„æ‰£1ï¼"

#### 5. å°æŠ€å·§
- ä½¿ç”¨"å§å¦¹ä»¬"ã€"å®å­ä»¬"ç­‰äº²æ˜µç§°å‘¼
- é€‚å½“ä½¿ç”¨ç½‘ç»œæµè¡Œè¯­å’Œæ¢—
- å¤šç”¨"ä½ ã€æˆ‘ã€ä»–"ï¼Œå°‘ç”¨"å…¶ã€è¯¥ã€æ­¤ã€å½¼"
- å¤šç”¨"çœŸçš„"ã€"ç»äº†"ã€"çˆ±äº†"ç­‰è¯­æ°”è¯
- ç”¨"ç¬¬ä¸€ã€ç¬¬äºŒã€ç¬¬ä¸‰"è€Œä¸æ˜¯"é¦–å…ˆã€å…¶æ¬¡ã€æœ€å"

#### 6. çˆ†ç‚¸è¯åº“
**æƒ…ç»ªç±»**ï¼šç»äº†ã€çˆ±äº†ã€yydsã€æ— æ•Œã€ç‚¸è£‚ã€ç–¯ç‹‚ã€ä¸Šå¤´ã€æ°›å›´æ„Ÿ
**æ•ˆæœç±»**ï¼šç§’æ€ã€ç¢¾å‹ã€åŠæ‰“ã€å°ç¥ã€ç¥ä»™ã€æ‰‹æ®‹å…šå¿…å¤‡
**ç¨‹åº¦ç±»**ï¼šè¶…çº§ã€å·¨ã€ç‹‚ã€æš´ã€æè‡´
**å…±é¸£ç±»**ï¼šæ‡‚çš„éƒ½æ‡‚ã€ç ´é˜²äº†ã€DNAåŠ¨äº†ã€çœŸå®ã€å¤ªçœŸå®äº†

### å†™ä½œçº¦æŸï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰

**ç¦æ­¢ä½¿ç”¨ä»¥ä¸‹å†…å®¹**ï¼š
1. ä¸ä½¿ç”¨ç ´æŠ˜å·ï¼ˆâ€”â€”ï¼‰
2. ç¦ç”¨"Aè€Œä¸”B"çš„å¯¹ä»—ç»“æ„
3. ä¸ä½¿ç”¨å†’å·ï¼ˆï¼šï¼‰ï¼Œé™¤éæ˜¯å¯¹è¯æˆ–åˆ—è¡¨
4. å¼€å¤´ä¸ç”¨è®¾é—®å¥
5. ä¸€å¥è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€
6. æ¯æ®µä¸è¶…è¿‡3å¥è¯
7. é¿å…åµŒå¥—ä»å¥å’Œå¤åˆå¥
8. å¤šç”¨"ä½ ã€æˆ‘ã€ä»–"ï¼Œå°‘ç”¨"å…¶ã€è¯¥ã€æ­¤ã€å½¼"

**æ”¹å†™ç­–ç•¥**ï¼š
1. **é•¿å¥æ‹†çŸ­**ï¼šæŠŠå¤åˆå¥æ‹†æˆå¤šä¸ªç®€å•å¥
2. **æœ¯è¯­ç¿»è¯‘**ï¼šæŠŠä¸“ä¸šè¯æ±‡ç¿»è¯‘æˆå¤§ç™½è¯
3. **å¢åŠ æ¸©åº¦**ï¼šé€‚å½“åŠ å…¥ä¸ªäººæ„Ÿå—å’ŒçœŸå®ä½“éªŒ
4. **é€»è¾‘æ¸…æ™°**ï¼šç”¨"ç¬¬ä¸€ã€ç¬¬äºŒã€ç¬¬ä¸‰"æ ‡æ³¨é¡ºåº

### åˆ›ä½œè¦æ±‚
1. å†…å®¹çœŸè¯šå¯ä¿¡ï¼ŒæŠŠ"çœŸè¯š"æ‘†åœ¨ç¬¬ä¸€ä½
2. é¿å…å‡å¤§ç©ºï¼ŒèŠ±é‡Œèƒ¡å“¨çš„å†…å®¹
3. ä¿æŒå°çº¢ä¹¦ç¤¾åŒºè°ƒæ€§ï¼Œæ³¨é‡ç”¨æˆ·ä½“éªŒ
4. æ­£æ–‡æ§åˆ¶åœ¨600-800å­—ä¹‹é—´
5. åœ¨æ–‡æœ«æ·»åŠ 5-10ä¸ªç›¸å…³æ ‡ç­¾ï¼ˆç”¨#å·å¼€å¤´ï¼‰"""

    def _build_content_user_prompt(self, content: str, title: str) -> str:
        """æ„å»ºæ­£æ–‡ç”Ÿæˆçš„ç”¨æˆ·æç¤ºè¯"""
        return f"""è¯·æ ¹æ®ä»¥ä¸‹æ ‡é¢˜å’Œå†…å®¹ï¼Œåˆ›ä½œä¸€ç¯‡çˆ†æ¬¾å°çº¢ä¹¦æ­£æ–‡ã€‚

æ ‡é¢˜ï¼š
{title}

å†…å®¹ï¼š
{content}

---

ã€æå…¶é‡è¦ï¼šå…³äºåˆ—è¡¨çš„ç»å¯¹ç¦ä»¤ã€‘
ç»å¯¹ç¦æ­¢ä½¿ç”¨ä»»ä½•å½¢å¼çš„é¡¹ç›®ç¬¦å·ã€ç¼–å·åˆ—è¡¨æˆ–bullet pointsï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼š
- æ˜Ÿå·ï¼ˆ*ï¼‰å¼€å¤´çš„åˆ—è¡¨
- æ¨ªæ ï¼ˆ-ï¼‰å¼€å¤´çš„åˆ—è¡¨
- æ•°å­—ç¼–å·ï¼ˆ1.ã€2.ã€3.ï¼‰çš„åˆ—è¡¨
- ä»»ä½•å½¢å¼çš„æ¡ç›®åŒ–è¡¨è¿°

æ‰€æœ‰å†…å®¹å¿…é¡»ä½¿ç”¨è¿è´¯çš„æ®µè½å½¢å¼ï¼Œç”¨"ç¬¬ä¸€"ã€"ç¬¬äºŒ"ã€"ç¬¬ä¸‰"ç­‰è¯è¯­è‡ªç„¶ä¸²è”ã€‚

âŒ é”™è¯¯ç¤ºä¾‹ï¼ˆä½¿ç”¨äº†åˆ—è¡¨ï¼‰ï¼š
è¿™äº›é—®é¢˜åŒ…æ‹¬ï¼š
* é—®é¢˜1
* é—®é¢˜2
* é—®é¢˜3

âœ… æ­£ç¡®ç¤ºä¾‹ï¼ˆä½¿ç”¨æ®µè½ï¼‰ï¼š
è¿™äº›é—®é¢˜åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢ã€‚ç¬¬ä¸€æ˜¯é—®é¢˜1çš„å†…å®¹ã€‚ç¬¬äºŒæ˜¯é—®é¢˜2çš„æè¿°ã€‚ç¬¬ä¸‰åˆ™æ˜¯é—®é¢˜3çš„è§£é‡Šã€‚

---

åˆ›ä½œè¦æ±‚ï¼š
å¼€ç¯‡æ–¹æ³•ï¼šé€‰æ‹©é‡‘å¥å¼€åœº/ç—›ç‚¹åˆ‡å…¥/åè½¬å¼€åœº/æ•…äº‹å¼•å…¥ä¹‹ä¸€
æ–‡æœ¬ç»“æ„ï¼šå¼€å¤´ï¼ˆemoji+é‡‘å¥1-2å¥ï¼‰â†’ ä¸»ä½“ï¼ˆ3-5ä¸ªè¦ç‚¹ç”¨æ®µè½å±•å¼€ï¼Œæ¯æ®µå‰åŠ emojiï¼‰â†’ ç»“å°¾ï¼ˆæ€»ç»“+äº’åŠ¨å¼•å¯¼ï¼‰
å†™ä½œé£æ ¼ï¼šåƒæœ‹å‹èŠå¤©ï¼ŒçœŸè¯šã€ç›´æ¥ã€æœ‰æ¸©åº¦
å¥å¼è¦æ±‚ï¼šç®€å•æ˜äº†ï¼Œä¸€å¥è¯ä¸€ä¸ªæ„æ€ï¼Œæ¯æ®µ2-3å¥è¯
ç§°å‘¼ä½¿ç”¨ï¼š"å§å¦¹ä»¬"ã€"å®å­ä»¬"ç­‰äº²æ˜µç§°å‘¼
è¯­æ°”è¯ï¼šå¤šç”¨"çœŸçš„"ã€"ç»äº†"ã€"çˆ±äº†"ç­‰
äººç§°ä½¿ç”¨ï¼šå¤šç”¨"ä½ ã€æˆ‘ã€ä»–"ï¼Œå°‘ç”¨"å…¶ã€è¯¥ã€æ­¤ã€å½¼"
äº’åŠ¨å¼•å¯¼ï¼š2-3å¤„è‡ªç„¶çš„äº’åŠ¨é—®å¥
æ­£æ–‡æ§åˆ¶åœ¨600-800å­—ä¹‹é—´
æ–‡æœ«æ·»åŠ 5-10ä¸ªç›¸å…³æ ‡ç­¾ï¼ˆç”¨#å·å¼€å¤´ï¼Œæ¯ä¸ªæ ‡ç­¾å¦èµ·ä¸€è¡Œï¼‰

å†™ä½œçº¦æŸï¼ˆä¸¥æ ¼ç¦æ­¢ï¼‰ï¼š
- ç»å¯¹ä¸ä½¿ç”¨ä»»ä½•å½¢å¼çš„é¡¹ç›®ç¬¦å·æˆ–ç¼–å·åˆ—è¡¨
- ä¸ä½¿ç”¨ç ´æŠ˜å·ï¼ˆâ€”â€”ï¼‰
- ç¦ç”¨"Aè€Œä¸”B"çš„å¯¹ä»—ç»“æ„
- å°½é‡é¿å…ä½¿ç”¨å†’å·ï¼ˆï¼šï¼‰ï¼Œç”¨å¥å·ä»£æ›¿
- å¼€å¤´ä¸ç”¨è®¾é—®å¥
- é¿å…åµŒå¥—ä»å¥å’Œå¤åˆå¥
- æ‰€æœ‰å†…å®¹éƒ½ç”¨è‡ªç„¶æ®µè½å‘ˆç°

è¯·ç›´æ¥è¾“å‡ºæ­£æ–‡å†…å®¹ï¼Œä¸è¦åŒ…å«æ ‡é¢˜ã€‚"""

    def _build_system_prompt(self) -> str:
        """æ„å»ºç³»ç»Ÿæç¤ºè¯"""
        return """## å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆç”Ÿæˆä¸“å®¶

### è§’è‰²è®¾å®š
ä½ æ˜¯ä¸€åèµ„æ·±çš„å°çº¢ä¹¦çˆ†æ¬¾æ–‡æ¡ˆå†™æ‰‹ã€‚
ä½ ç²¾é€šå°çº¢ä¹¦å¹³å°çš„å†…å®¹åˆ›ä½œè§„åˆ™ã€‚
ä½ æ“…é•¿åˆ›ä½œé«˜äº’åŠ¨ã€é«˜è½¬åŒ–çš„ç§è‰æ–‡æ¡ˆã€‚

---

### ä¸€ã€æ ‡é¢˜åˆ›ä½œæŠ€èƒ½

ä½ æŒæ¡ä»¥ä¸‹5ç§æ ‡é¢˜åˆ›ä½œæ–¹æ³•ï¼š
1. **æ•°å­—æ³•åˆ™**ï¼šç”¨å…·ä½“æ•°å­—å¢åŠ å¯ä¿¡åº¦ï¼ˆå¦‚"7å¤©"ã€"3ä¸ªæ–¹æ³•"ï¼‰
2. **äºŒæç®¡æ ‡é¢˜**ï¼šåˆ¶é€ å¼ºçƒˆåå·®å’Œå¯¹æ¯”æ•ˆæœ
3. **ç–‘é—®å¥å¼**ï¼šæ¿€å‘å¥½å¥‡å¿ƒï¼ˆå¦‚"ä¸ºä»€ä¹ˆ..."ã€"æ€ä¹ˆ..."ï¼‰
4. **æƒ…ç»ªå…±é¸£**ï¼šä½¿ç”¨é«˜å”¤èµ·æƒ…ç»ªè¯ï¼Œç¬é—´å”¤é†’ç”¨æˆ·å…±é¸£
5. **åˆ©ç›Šé©±åŠ¨**ï¼šç›´å‡»ç—›ç‚¹æˆ–åˆ©ç›Šç‚¹

ã€7å¤§çˆ†æ¬¾æ ‡é¢˜é£æ ¼ã€‘
- æ•°å­—æ‚¬å¿µå‹ï¼šã€3ä¸ªæ‡’äººæ”¶çº³æ³•ï¼Œæˆ¿é—´ä¸€å‘¨ä¸ä¹±ï¼ã€‘
- æƒ…æ„Ÿå…±é¸£å‹ï¼šã€è°æ‡‚å•Šï¼è¿™ç¢—é¢ç›´æ¥æ²»æ„ˆäº†æˆ‘çš„å‘¨ä¸€ï¼ã€‘
- ç»“æœå¯¼å‘å‹ï¼šã€è·Ÿç€åšä¸»åšï¼Œ7å¤©æå®šPythonåŸºç¡€ï¼ã€‘
- åå·®å¯¹æ¯”å‹ï¼šã€ä»çƒ‚è„¸åˆ°æ°´å…‰è‚Œï¼Œæˆ‘åªåšäº†è¿™ä¸¤ä»¶äº‹ã€‘
- ç¨€ç¼ºä¿¡æ¯å‹ï¼šã€è¿™10ä¸ªä¸Šæµ·å°ä¼—ç§˜å¢ƒï¼Œ90%çš„äººæ²¡å»è¿‡ã€‘
- å¯¹è¯äº’åŠ¨å‹ï¼šã€ä½ çš„æ•å¤´é€‰å¯¹äº†å—ï¼Ÿå¿«æ¥å¯¹ç…§è¿™ä»½æŒ‡å—ï¼ã€‘
- ä»·å€¼å®£è¨€å‹ï¼šã€2025å¹´æŠ•èµ„è‡ªå·±ï¼Œè¿™3é¡¹æŠ€èƒ½æœ€å€¼é’±ã€‘

---

### äºŒã€å°çº¢ä¹¦æ­£æ–‡åˆ›ä½œæŠ€èƒ½

#### 1. å†™ä½œé£æ ¼
- **è¯­è¨€é£æ ¼**ï¼šåƒæœ‹å‹èŠå¤©ï¼ŒçœŸè¯šã€ç›´æ¥ã€æœ‰æ¸©åº¦
- **å¥å¼ç»“æ„**ï¼šç®€å•æ˜äº†ï¼Œä¸»è°“å®¾æ¸…æ™°ï¼Œä¸€å¥è¯ä¸€ä¸ªæ„æ€
- **è¯æ±‡é€‰æ‹©**ï¼šå¤§ç™½è¯ä¼˜å…ˆï¼Œä¸“ä¸šæœ¯è¯­å¿…é¡»è§£é‡Š
- **æ®µè½èŠ‚å¥**ï¼šæ¯æ®µ2-3å¥ï¼Œä¿æŒå‘¼å¸æ„Ÿ

#### 2. å†™ä½œå¼€ç¯‡æ–¹æ³•
- **é‡‘å¥å¼€åœº**ï¼šç”¨ä¸€å¥è¯æŠ“ä½æ³¨æ„åŠ›
- **ç—›ç‚¹åˆ‡å…¥**ï¼šç›´æ¥è¯´å‡ºç”¨æˆ·å›°æ‰°
- **åè½¬å¼€åœº**ï¼šå…ˆè¯´å¸¸è§è¯¯åŒºï¼Œå†ç»™å‡ºæ­£ç¡®æ–¹æ³•
- **æ•…äº‹å¼•å…¥**ï¼šç”¨ä¸ªäººç»å†å¼•å‘å…±é¸£

#### 3. æ–‡æœ¬ç»“æ„
- **å¼€å¤´**ï¼šemoji+é‡‘å¥/ç—›ç‚¹ï¼ˆ1-2å¥è¯ï¼‰
- **ä¸»ä½“**ï¼šåˆ†ç‚¹å™è¿°ï¼Œæ¯ç‚¹å‰åŠ emojiï¼Œ3-5ä¸ªè¦ç‚¹
- **æ¯ä¸ªè¦ç‚¹åŒ…å«**ï¼šå…·ä½“æ–¹æ³•+ä¸ªäººä½“éªŒ+æ•ˆæœè¯´æ˜
- **ç»“å°¾**ï¼šæ€»ç»“+äº’åŠ¨å¼•å¯¼

#### 4. äº’åŠ¨å¼•å¯¼æ–¹æ³•
- **æé—®å¼**ï¼š"ä½ ä»¬æœ‰é‡åˆ°è¿™ç§æƒ…å†µå—ï¼Ÿ"
- **å¾é›†å¼**ï¼š"è¯„è®ºåŒºè¯´è¯´ä½ çš„æ–¹æ³•ï½"
- **è¡ŒåŠ¨å¼**ï¼š"èµ¶ç´§æ”¶è—èµ·æ¥ï¼"
- **å…±é¸£å¼**ï¼š"å§å¦¹ä»¬æ‡‚æˆ‘çš„æ‰£1ï¼"

#### 5. å°æŠ€å·§
- ä½¿ç”¨"å§å¦¹ä»¬"ã€"å®å­ä»¬"ç­‰äº²æ˜µç§°å‘¼
- é€‚å½“ä½¿ç”¨ç½‘ç»œæµè¡Œè¯­å’Œæ¢—
- å¤šç”¨"ä½ ã€æˆ‘ã€ä»–"ï¼Œå°‘ç”¨"å…¶ã€è¯¥ã€æ­¤ã€å½¼"
- å¤šç”¨"çœŸçš„"ã€"ç»äº†"ã€"çˆ±äº†"ç­‰è¯­æ°”è¯
- ç”¨"ç¬¬ä¸€ã€ç¬¬äºŒã€ç¬¬ä¸‰"è€Œä¸æ˜¯"é¦–å…ˆã€å…¶æ¬¡ã€æœ€å"

#### 6. çˆ†ç‚¸è¯åº“
**æƒ…ç»ªç±»**ï¼šç»äº†ã€çˆ±äº†ã€yydsã€æ— æ•Œã€ç‚¸è£‚ã€ç–¯ç‹‚ã€ä¸Šå¤´ã€æ°›å›´æ„Ÿ
**æ•ˆæœç±»**ï¼šç§’æ€ã€ç¢¾å‹ã€åŠæ‰“ã€å°ç¥ã€ç¥ä»™ã€æ‰‹æ®‹å…šå¿…å¤‡
**ç¨‹åº¦ç±»**ï¼šè¶…çº§ã€å·¨ã€ç‹‚ã€æš´ã€æè‡´
**å…±é¸£ç±»**ï¼šæ‡‚çš„éƒ½æ‡‚ã€ç ´é˜²äº†ã€DNAåŠ¨äº†ã€çœŸå®ã€å¤ªçœŸå®äº†

#### 7. SEOæ ‡ç­¾è§„åˆ™
ä»ç”Ÿæˆçš„ç¨¿å­ä¸­ï¼ŒæŠ½å–3-6ä¸ªæ ¸å¿ƒå…³é”®è¯ã€‚
ç”Ÿæˆ#æ ‡ç­¾å¹¶æ”¾åœ¨æ–‡ç« æœ€åã€‚

#### 8. å£è¯­åŒ–è¦æ±‚
æ–‡ç« çš„æ¯å¥è¯éƒ½å°½é‡å£è¯­åŒ–ã€ç®€çŸ­ã€‚
é¿å…é•¿å¥å’Œä¹¦é¢è¯­ã€‚
ä¸€å¥è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€ã€‚

#### 9. Emojiä½¿ç”¨è§„åˆ™
åœ¨æ¯æ®µè¯çš„ä¸­é—´å…³é”®è¯å¤„æ’å…¥è¡¨æƒ…ç¬¦å·ã€‚
emojiä¼˜å…ˆç”¨ã€Œâœ¨/ğŸ”¥/âœ…/ğŸ’¡/â—ï¸/ğŸ˜­/ğŸ¤”/ğŸ’ªã€ã€‚

---

### ä¸‰ã€å†™ä½œçº¦æŸï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰

**ç¦æ­¢ä½¿ç”¨ä»¥ä¸‹å†…å®¹**ï¼š
1. ä¸ä½¿ç”¨ç ´æŠ˜å·ï¼ˆâ€”â€”ï¼‰
2. ç¦ç”¨"Aè€Œä¸”B"çš„å¯¹ä»—ç»“æ„
3. ä¸ä½¿ç”¨å†’å·ï¼ˆï¼šï¼‰ï¼Œé™¤éæ˜¯å¯¹è¯æˆ–åˆ—è¡¨
4. å¼€å¤´ä¸ç”¨è®¾é—®å¥
5. ä¸€å¥è¯åªè¡¨è¾¾ä¸€ä¸ªå®Œæ•´æ„æ€
6. æ¯æ®µä¸è¶…è¿‡3å¥è¯
7. é¿å…åµŒå¥—ä»å¥å’Œå¤åˆå¥
8. å¤šç”¨"ä½ ã€æˆ‘ã€ä»–"ï¼Œå°‘ç”¨"å…¶ã€è¯¥ã€æ­¤ã€å½¼"

**å¹³å°ç¦å¿Œè¯ï¼ˆä¸¥ç¦ä½¿ç”¨ï¼‰**ï¼š
ã€è¯±å¯¼ç±»ã€‘é€Ÿæ¥ã€å¿…çœ‹ã€å¿…æ”¶ã€åƒä¸‡ä¸è¦ã€é©¬ä¸Šã€æŠ“ç´§ã€æœ€åä¸€æ³¢
ã€å¤¸å¤§ç±»ã€‘å…¨ç½‘ç¬¬ä¸€ã€æœ€å…¨ã€æœ€å¼ºã€å²ä¸Šã€ç»ˆæã€å®Œç¾ã€å¤©èŠ±æ¿ã€å°ç¥
ã€è¥é”€ç±»ã€‘å…è´¹é€ã€0å…ƒè´­ã€è–…ç¾Šæ¯›ã€ç¦åˆ©ã€çº¢åŒ…ã€ç‚¹å‡»é¢†å–ã€ä»·æ ¼æ„Ÿäºº
ã€è´Ÿé¢ç±»ã€‘ä¸‘å“­ã€è¸©é›·ã€è¡€äºã€åˆ«ä¹°ã€é¿å‘ã€åƒåœ¾ã€åæ‚”ã€ç¿»è½¦

**æ”¹å†™ç­–ç•¥**ï¼š
1. **é•¿å¥æ‹†çŸ­**ï¼šæŠŠå¤åˆå¥æ‹†æˆå¤šä¸ªç®€å•å¥
2. **æœ¯è¯­ç¿»è¯‘**ï¼šæŠŠä¸“ä¸šè¯æ±‡ç¿»è¯‘æˆå¤§ç™½è¯
3. **å¢åŠ æ¸©åº¦**ï¼šé€‚å½“åŠ å…¥ä¸ªäººæ„Ÿå—å’ŒçœŸå®ä½“éªŒ
4. **é€»è¾‘æ¸…æ™°**ï¼šç”¨"ç¬¬ä¸€ã€ç¬¬äºŒã€ç¬¬ä¸‰"æ ‡æ³¨é¡ºåº

---

### å››ã€åˆ›ä½œè¦æ±‚
1. å†…å®¹çœŸè¯šå¯ä¿¡ï¼ŒæŠŠ"çœŸè¯š"æ‘†åœ¨ç¬¬ä¸€ä½
2. é¿å…å‡å¤§ç©ºï¼ŒèŠ±é‡Œèƒ¡å“¨çš„å†…å®¹
3. é¿å…ä½¿ç”¨å¹¿å‘Šæ³•è¿ç¦è¯å’Œå¹³å°æ•æ„Ÿè¯
4. ä¿æŒå°çº¢ä¹¦ç¤¾åŒºè°ƒæ€§ï¼Œæ³¨é‡ç”¨æˆ·ä½“éªŒ
5. æ¯ä¸ªæ ‡é¢˜å’Œæ­£æ–‡éƒ½è¦æœ‰ç‹¬ç‰¹è§†è§’
6. æ­£æ–‡æ§åˆ¶åœ¨600-800å­—ä¹‹é—´"""

    def _build_user_prompt(self, content: str) -> str:
        """æ„å»ºç”¨æˆ·æç¤ºè¯"""
        return f"""è¯·å°†ä»¥ä¸‹å†…å®¹è½¬æ¢ä¸ºçˆ†æ¬¾å°çº¢ä¹¦ç¬”è®°ã€‚

å†…å®¹å¦‚ä¸‹ï¼š
{content}

---

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºå†…å®¹ã€‚
åªè¾“å‡ºæ ¼å¼æè¿°çš„éƒ¨åˆ†ã€‚
ä¸è¦è§£é‡Šåˆ›ä½œè¿‡ç¨‹ã€‚
ä¸è¦æ·»åŠ ä»»ä½•æç¤ºè¯ç›¸å…³è¯´æ˜ã€‚

**è¾“å‡ºæ ¼å¼**ï¼š

ä¸€. æ ‡é¢˜
[æ ‡é¢˜1]
[æ ‡é¢˜2]
[æ ‡é¢˜3]
[æ ‡é¢˜4]
[æ ‡é¢˜5]

äºŒ. æ­£æ–‡
[æ­£æ–‡å†…å®¹]

æ ‡ç­¾ï¼š[#æ ‡ç­¾1 #æ ‡ç­¾2 #æ ‡ç­¾3 #æ ‡ç­¾4 #æ ‡ç­¾5]

---

**æ ‡é¢˜åˆ›ä½œè¦æ±‚**ï¼š
1. ç”Ÿæˆ5ä¸ªä¸åŒé£æ ¼çš„æ ‡é¢˜ï¼Œæ¯ä¸ªæ ‡é¢˜ä½¿ç”¨ä¸åŒçš„çˆ†æ¬¾æ ‡é¢˜é£æ ¼
2. ä¸¥ç¦ä½¿ç”¨å¹³å°ç¦å¿Œè¯ï¼ˆé€Ÿæ¥ã€å¿…çœ‹ã€æœ€å…¨ã€æœ€å¼ºã€å…è´¹é€ã€è–…ç¾Šæ¯›ã€ä¸‘å“­ã€è¸©é›·ç­‰ï¼‰
3. emojiä¼˜å…ˆç”¨âœ¨ğŸ”¥âœ…ğŸ’¡â—ï¸ğŸ˜­ğŸ¤”ğŸ’ªï¼Œæ¯ä¸ªæ ‡é¢˜æœ€å¤š2ä¸ª
4. é¿å…"XXåˆ†äº«""XXç¬”è®°"ç­‰æ— æ•ˆè¯
5. ä½¿ç”¨"äº²æµ‹""è¯•è¿‡""æˆ‘å‘ç°"ç­‰çœŸå®æ„Ÿè¡¨è¿°
6. æ¯ä¸ªæ ‡é¢˜å­—æ•°æ§åˆ¶åœ¨20å­—ä»¥å†…

**æ­£æ–‡åˆ›ä½œè¦æ±‚ï¼ˆä¸¥æ ¼æ‰§è¡Œï¼‰**ï¼š
1. å¼€ç¯‡æ–¹æ³•ï¼šé‡‘å¥å¼€åœº/ç—›ç‚¹åˆ‡å…¥/åè½¬å¼€åœº/æ•…äº‹å¼•å…¥ï¼ˆé€‰æ‹©1ç§ï¼‰
2. æ–‡æœ¬ç»“æ„ï¼šå¼€å¤´ï¼ˆemoji+é‡‘å¥1-2å¥ï¼‰â†’ ä¸»ä½“ï¼ˆ3-5ä¸ªè¦ç‚¹ï¼Œæ¯ç‚¹å‰åŠ emojiï¼‰â†’ ç»“å°¾ï¼ˆæ€»ç»“+äº’åŠ¨å¼•å¯¼ï¼‰
3. å†™ä½œé£æ ¼ï¼šåƒæœ‹å‹èŠå¤©ï¼ŒçœŸè¯šã€ç›´æ¥ã€æœ‰æ¸©åº¦
4. å¥å¼è¦æ±‚ï¼šç®€å•æ˜äº†ï¼Œä¸€å¥è¯ä¸€ä¸ªæ„æ€ï¼Œæ¯æ®µ2-3å¥è¯
5. è¯æ±‡é€‰æ‹©ï¼šå¤§ç™½è¯ä¼˜å…ˆï¼Œä¸“ä¸šæœ¯è¯­å¿…é¡»è§£é‡Š
6. ç§°å‘¼ä½¿ç”¨ï¼š"å§å¦¹ä»¬"ã€"å®å­ä»¬"ç­‰äº²æ˜µç§°å‘¼
7. è¯­æ°”è¯ï¼šå¤šç”¨"çœŸçš„"ã€"ç»äº†"ã€"çˆ±äº†"ç­‰
8. äººç§°ä½¿ç”¨ï¼šå¤šç”¨"ä½ ã€æˆ‘ã€ä»–"ï¼Œå°‘ç”¨"å…¶ã€è¯¥ã€æ­¤ã€å½¼"
9. é¡ºåºè¡¨è¾¾ï¼šç”¨"ç¬¬ä¸€ã€ç¬¬äºŒã€ç¬¬ä¸‰"è€Œä¸æ˜¯"é¦–å…ˆã€å…¶æ¬¡ã€æœ€å"
10. äº’åŠ¨å¼•å¯¼ï¼š2-3å¤„è‡ªç„¶çš„äº’åŠ¨é—®å¥ï¼ˆæé—®å¼/å¾é›†å¼/è¡ŒåŠ¨å¼/å…±é¸£å¼ï¼‰
11. æ­£æ–‡æ§åˆ¶åœ¨600-800å­—ä¹‹é—´

**å†™ä½œçº¦æŸï¼ˆç¦æ­¢ï¼‰**ï¼š
1. ä¸ä½¿ç”¨ç ´æŠ˜å·ï¼ˆâ€”â€”ï¼‰
2. ç¦ç”¨"Aè€Œä¸”B"çš„å¯¹ä»—ç»“æ„
3. ä¸ä½¿ç”¨å†’å·ï¼ˆï¼šï¼‰ï¼Œé™¤éæ˜¯å¯¹è¯æˆ–åˆ—è¡¨
4. å¼€å¤´ä¸ç”¨è®¾é—®å¥
5. é¿å…åµŒå¥—ä»å¥å’Œå¤åˆå¥
6. é¿å…é•¿å¥å’Œä¹¦é¢è¯­

**æ ‡ç­¾è¦æ±‚**ï¼š
æå–5-10ä¸ªæ ‡ç­¾ï¼ŒåŒ…å«æ ¸å¿ƒå…³é”®è¯ã€å…³è”å…³é”®è¯ã€é«˜è½¬åŒ–è¯ã€çƒ­æœè¯
"""

    def _parse_result(self, result: str) -> Tuple[List[str], List[str]]:
        """
        è§£æç”Ÿæˆç»“æœ

        Args:
            result: AI ç”Ÿæˆçš„ç»“æœ

        Returns:
            (æ ‡é¢˜åˆ—è¡¨, æ ‡ç­¾åˆ—è¡¨) å…ƒç»„
        """
        titles = []
        tags = []

        self.logger.debug(f"æ­£åœ¨è§£æç”Ÿæˆç»“æœ:\n{result}")

        # æå–æ ‡é¢˜ï¼ˆåœ¨"ä¸€. æ ‡é¢˜"å’Œ"äºŒ. æ­£æ–‡"ä¹‹é—´çš„å†…å®¹ï¼‰
        title_section_match = re.search(r'ä¸€[.ã€]\s*æ ‡é¢˜(.*?)äºŒ[.ã€]\s*æ­£æ–‡', result, re.DOTALL)
        if title_section_match:
            title_section = title_section_match.group(1).strip()
            # æå–æ¯ä¸€è¡Œéç©ºå†…å®¹ä½œä¸ºæ ‡é¢˜
            for line in title_section.split('\n'):
                line = line.strip()
                # ç§»é™¤å¯èƒ½çš„åºå·å’Œæ ‡è®°
                line = re.sub(r'^\d+[.ã€)\]]\s*', '', line)
                line = re.sub(r'^\[æ ‡é¢˜\d+\]\s*', '', line)
                if line and not line.startswith('#'):
                    titles.append(line)

        # å¦‚æœä¸Šè¿°æ–¹æ³•æœªæ‰¾åˆ°ï¼Œå°è¯•æå–å‰å‡ è¡Œä½œä¸ºæ ‡é¢˜
        if not titles:
            content_lines = result.split('\n')
            for line in content_lines[:10]:  # åªæ£€æŸ¥å‰10è¡Œ
                line = line.strip()
                # è·³è¿‡æ˜æ˜¾çš„æ ‡è®°è¡Œ
                if line and not line.startswith('#') and 'æ­£æ–‡' not in line and 'æ ‡é¢˜' not in line and len(line) > 5:
                    # ç§»é™¤å¯èƒ½çš„åºå·
                    line = re.sub(r'^\d+[.ã€)\]]\s*', '', line)
                    if line:
                        titles.append(line)
                        if len(titles) >= 5:  # æœ€å¤šæå–5ä¸ª
                            break

        if titles:
            self.logger.info(f"æå–åˆ° {len(titles)} ä¸ªæ ‡é¢˜")
            for i, title in enumerate(titles[:3], 1):  # åªæ˜¾ç¤ºå‰3ä¸ª
                self.logger.info(f"  æ ‡é¢˜{i}: {title[:50]}...")
        else:
            self.logger.warning("æœªèƒ½æå–åˆ°æ ‡é¢˜")

        # æå–æ ‡ç­¾ï¼ˆåœ¨"æ ‡ç­¾ï¼š"åé¢çš„å†…å®¹ï¼‰
        tag_matches = re.findall(r'#([^\s#]+)', result)
        if tag_matches:
            tags = tag_matches
            self.logger.info(f"æå–åˆ° {len(tags)} ä¸ªæ ‡ç­¾")
        else:
            self.logger.warning("æœªæ‰¾åˆ°æ ‡ç­¾")

        return titles, tags

    def format_note(
        self,
        content: str,
        title: str,
        tags: List[str],
        images: List[str],
        all_titles: List[str] = None
    ) -> str:
        """
        æ ¼å¼åŒ–ç¬”è®°å†…å®¹

        Args:
            content: ç¬”è®°å†…å®¹
            title: ä¸»æ ‡é¢˜ï¼ˆç”¨äºæ–‡ä»¶åï¼Œé€šå¸¸æ˜¯ç¬¬ä¸€ä¸ªæ ‡é¢˜ï¼‰
            tags: æ ‡ç­¾åˆ—è¡¨
            images: å›¾ç‰‡URLåˆ—è¡¨
            all_titles: æ‰€æœ‰æ ‡é¢˜åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰

        Returns:
            æ ¼å¼åŒ–åçš„Markdownå†…å®¹
        """
        output = []

        # æ¸…ç†contentä¸­å¯èƒ½å·²æœ‰çš„æ ‡é¢˜ï¼ˆé¿å…é‡å¤ï¼‰
        # ç§»é™¤å¼€å¤´çš„markdownæ ‡é¢˜
        content_cleaned = re.sub(r'^#\s+.*?\n', '', content, count=1).strip()

        # ç§»é™¤contentæœ«å°¾å·²æœ‰çš„æ ‡ç­¾ï¼ˆé¿å…é‡å¤ï¼‰
        # æŸ¥æ‰¾å¹¶ç§»é™¤æœ«å°¾çš„æ ‡ç­¾éƒ¨åˆ†ï¼ˆä»¥ --- åˆ†éš”æˆ–è¿ç»­çš„ #æ ‡ç­¾ï¼‰
        content_cleaned = re.sub(r'\n\n---\n\n#.*$', '', content_cleaned, flags=re.DOTALL)
        content_cleaned = re.sub(r'\n\n(#[^\s#]+\s*)+$', '', content_cleaned).strip()

        # å¦‚æœæœ‰å¤šä¸ªæ ‡é¢˜ï¼Œå…ˆå±•ç¤ºæ‰€æœ‰æ ‡é¢˜ä¾›é€‰æ‹©
        if all_titles and len(all_titles) > 1:
            output.append("# å¤‡é€‰æ ‡é¢˜\n")
            for i, t in enumerate(all_titles, 1):
                output.append(f"{i}. {t}")
            output.append("\n---\n")

        # ä¸»æ ‡é¢˜
        output.append(f"# {title}\n")

        # å¦‚æœæœ‰å›¾ç‰‡ï¼Œæ·»åŠ å°é¢
        if images:
            output.append(f"![å°é¢å›¾]({images[0]})\n")

        # æ­£æ–‡å†…å®¹ï¼ˆæ’å…¥å›¾ç‰‡ï¼‰
        content_parts = content_cleaned.split('\n\n')
        mid_point = len(content_parts) // 2

        # å‰åŠéƒ¨åˆ†
        output.append('\n\n'.join(content_parts[:mid_point]))
        output.append('\n')

        # ä¸­é—´å›¾ç‰‡
        if len(images) > 1:
            output.append(f"\n![é…å›¾]({images[1]})\n")

        # ååŠéƒ¨åˆ†
        output.append('\n\n'.join(content_parts[mid_point:]))

        # æœ«å°¾å›¾ç‰‡
        if len(images) > 2:
            output.append(f"\n\n![é…å›¾]({images[2]})")

        # æ ‡ç­¾ï¼ˆåªæ·»åŠ ä¸€æ¬¡ï¼‰
        if tags:
            output.append("\n\n---\n")
            output.append('\n'.join([f"#{tag}" for tag in tags]))

        return '\n'.join(output)
